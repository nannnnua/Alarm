<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>띵동</title>
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      font-size: 48px;
      color: #333;
      margin-bottom: 10px;
    }

    #digitalClock {
      font-size: 64px;
      font-weight: 700;
      text-align: center;
      margin: 20px 0 30px 0;
      color: #333;
      padding: 20px;
      border-radius: 8px;
      background-color: #fafafa;
    }

    .section {
      background: #fafafa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .section label {
      font-weight: 600;
      color: #333;
      margin-right: 10px;
    }

    .alarm-input-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      align-items: center;
    }

    select, input[type="time"] {
      padding: 10px 15px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      font-family: 'Pretendard', sans-serif;
    }

    select:focus, input[type="time"]:focus {
      outline: none;
      border-color: #666;
    }

    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s;
      font-family: 'Pretendard', sans-serif;
      background: #333;
      color: white;
    }

    button:hover {
      background: #555;
    }

    button:active {
      transform: scale(0.98);
    }

    .btn-danger {
      background: #dc3545;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .button-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .button-group {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .button-group.right {
      margin-left: auto;
    }
    
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #ddd;
    }
    
    th, td {
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    
    th {
      background: #fafafa;
      color: #333;
      font-weight: 600;
    }

    tr:hover {
      background: #fafafa;
    }

    tr:last-child td {
      border-bottom: none;
    }

    td button {
      padding: 8px 16px;
      font-size: 14px;
      margin: 2px;
    }
    
    #alarmModal, #editModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 1000;
      text-align: center;
    }

    #alarmModal {
      display: none;
      border: 3px solid #dc3545;
    }

    #editModal {
      display: none;
      border: 2px solid #333;
    }

    #alarmModal h2 {
      font-size: 32px;
      color: #dc3545;
      margin-bottom: 20px;
    }

    #editModal h2 {
      color: #333;
      margin-bottom: 20px;
    }
    
    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }

    #uploadedFileName {
      color: #666;
      font-weight: 600;
      margin-left: 10px;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>띵동</h1>
    
    <div id="digitalClock">00:00:00</div>

    <div class="section">
      <div>
        <label>알림음 선택</label>
        <select id="soundSelect">
          <option value="beep">기본 삐소리</option>
          <option value="sound1">웃긴 삐소리</option>
          <option value="sound2">알람음 2</option>
          <option value="sound3">알람음 3</option>
          <option value="sound4">알람음 4</option>
          <option value="sound5">알람음 5</option>
          <option value="upload">내 파일 업로드</option>
        </select>
        <button onclick="handleSoundSelect()">적용</button>
        <input type="file" id="soundFileInput" accept=".mp3,.wav,.ogg" style="display:none" onchange="handleSoundUpload(event)">
        <span id="uploadedFileName"></span>
      </div>

      <div class="alarm-input-group">
        <label>알람 설정</label>
        <input type="time" id="alarmTime">
        <button onclick="setAlarm()">설정</button>
      </div>
    </div>

    <div class="button-row">
      <div class="button-group">
        <button onclick="exportToCSV()">CSV 내보내기</button>
        <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="importFromCSV(event)">
        <button onclick="document.getElementById('csvFileInput').click()">CSV 불러오기</button>
      </div>
      <div class="button-group right">
        <button onclick="deleteSelected()" class="btn-danger">선택 삭제</button>
        <button onclick="deleteAll()" class="btn-danger">전체 삭제</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th><input type="checkbox" id="checkAll" onchange="toggleCheckAll()"></th>
          <th>설정 시간</th>
          <th>편집</th>
          <th>삭제</th>
        </tr>
      </thead>
      <tbody id="alarmList"></tbody>
    </table>
  </div>

  <div id="overlay"></div>
  <div id="alarmModal">
    <h2>알람</h2>
    <p id="alarmTimeText" style="font-size: 24px; margin: 20px 0;"></p>
    <button onclick="stopAlarm()" class="btn-danger" style="font-size: 18px; padding: 12px 24px;">끄기</button>
  </div>

  <div id="editModal">
    <h2>알람 시간 편집</h2>
    <p style="margin: 20px 0;">새로운 시간을 선택하세요</p>
    <input type="time" id="editTimeInput" style="font-size: 18px; padding: 12px;">
    <div style="margin-top: 20px;">
      <button onclick="saveEdit()">저장</button>
      <button onclick="cancelEdit()" class="btn-danger">취소</button>
    </div>
  </div>

  <script>
    let alarms = [];
    let audioContext = null;
    let oscillator = null;
    let isAlarmRinging = false;
    let editingIndex = -1;
    let currentSoundType = 'beep';
    let uploadedSoundURL = null;
    let currentAudio = null;

    const soundFiles = {
      sound1: 'sounds/alarm1.mp3',
      sound2: 'sounds/alarm2.mp3',
      sound3: 'sounds/alarm3.mp3',
      sound4: 'sounds/alarm4.mp3',
      sound5: 'sounds/alarm5.mp3'
    };

    function setAlarm() {
      const timeInput = document.getElementById('alarmTime').value;
      
      if (timeInput) {
        if (alarms.includes(timeInput)) {
          alert('이미 설정된 시간입니다!');
          return;
        }
        
        alarms.push(timeInput);
        saveToLocalStorage();
        displayAlarms();
        alert('설정 완료');
        document.getElementById('alarmTime').value = '';
      } else {
        alert('시간을 선택해주세요!');
      }
    }

    function deleteAlarm(index) {
      alarms.splice(index, 1);
      saveToLocalStorage();
      displayAlarms();
    }

    function editAlarm(index) {
      editingIndex = index;
      document.getElementById('editTimeInput').value = alarms[index];
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('editModal').style.display = 'block';
    }

    function saveEdit() {
      const newTime = document.getElementById('editTimeInput').value;
      
      if (newTime) {
        if (alarms.includes(newTime) && alarms[editingIndex] !== newTime) {
          alert('이미 설정된 시간입니다!');
          return;
        }
        
        alarms[editingIndex] = newTime;
        saveToLocalStorage();
        displayAlarms();
        cancelEdit();
        alert('수정 완료');
      } else {
        alert('시간을 선택해주세요!');
      }
    }

    function cancelEdit() {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('editModal').style.display = 'none';
      editingIndex = -1;
    }

    function displayAlarms() {
      const list = document.getElementById('alarmList');
      
      if (alarms.length === 0) {
        list.innerHTML = '<tr><td colspan="4" style="padding: 30px; color: #999;">설정된 알람이 없습니다</td></tr>';
      } else {
        list.innerHTML = alarms.map((alarm, index) => `
          <tr>
            <td><input type="checkbox" class="alarmCheckbox" data-index="${index}"></td>
            <td style="font-weight: 600; font-size: 18px;">${alarm}</td>
            <td><button onclick="editAlarm(${index})">편집</button></td>
            <td><button onclick="deleteAlarm(${index})" class="btn-danger">삭제</button></td>
          </tr>
        `).join('');
      }
      
      document.getElementById('checkAll').checked = false;
    }

    function playAlarmSound() {
      if (currentSoundType === 'beep') {
        playBeepSound();
      } else if (currentSoundType === 'upload' && uploadedSoundURL) {
        playUploadedSound(uploadedSoundURL);
      } else if (soundFiles[currentSoundType]) {
        playUploadedSound(soundFiles[currentSoundType]);
      } else {
        playBeepSound();
      }
    }

    function playBeepSound() {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      
      oscillator.start();
      
      isAlarmRinging = true;
      repeatSound();
    }

    function playUploadedSound(url) {
      currentAudio = new Audio(url);
      currentAudio.loop = true;
      currentAudio.play().catch(error => {
        console.error('소리 재생 실패:', error);
        alert('알림음 파일을 찾을 수 없습니다. 기본 삐소리로 재생합니다.');
        playBeepSound();
      });
      isAlarmRinging = true;
    }

    function repeatSound() {
      if (isAlarmRinging) {
        setTimeout(() => {
          if (isAlarmRinging && oscillator) {
            oscillator.stop();
            playAlarmSound();
          }
        }, 1000);
      }
    }

    function showAlarm(alarmTime) {
      document.getElementById('alarmTimeText').textContent = `설정 시간: ${alarmTime}`;
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('alarmModal').style.display = 'block';
      playAlarmSound();
    }

    function stopAlarm() {
      isAlarmRinging = false;
      
      if (oscillator) {
        oscillator.stop();
        oscillator = null;
      }
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
      
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
      }
      
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('alarmModal').style.display = 'none';
    }

    function handleSoundSelect() {
      const select = document.getElementById('soundSelect');
      const selectedValue = select.value;
      
      if (selectedValue === 'upload') {
        document.getElementById('soundFileInput').click();
      } else {
        currentSoundType = selectedValue;
        document.getElementById('uploadedFileName').textContent = '';
        
        if (selectedValue === 'beep') {
          alert('기본 삐소리로 설정되었습니다.');
        } else {
          alert(select.options[select.selectedIndex].text + '로 설정되었습니다.');
        }
      }
    }

    function handleSoundUpload(event) {
      const file = event.target.files[0];
      
      if (file) {
        if (uploadedSoundURL) {
          URL.revokeObjectURL(uploadedSoundURL);
        }
        
        uploadedSoundURL = URL.createObjectURL(file);
        currentSoundType = 'upload';
        document.getElementById('uploadedFileName').textContent = ` (${file.name})`;
        alert('알림음이 설정되었습니다: ' + file.name);
      } else {
        document.getElementById('soundSelect').value = 'beep';
        currentSoundType = 'beep';
        document.getElementById('uploadedFileName').textContent = '';
      }
      
      event.target.value = '';
    }

    setInterval(() => {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const seconds = now.getSeconds();
      const currentTime = hours.toString().padStart(2, '0') + ':' + 
                         minutes.toString().padStart(2, '0');

      if (seconds === 0) {
        alarms.forEach((alarm) => {
          if (alarm === currentTime && !isAlarmRinging) {
            showAlarm(alarm);
          }
        });
      }
    }, 1000);

    function saveToLocalStorage() {
      localStorage.setItem('alarms', JSON.stringify(alarms));
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem('alarms');
      if (saved) {
        alarms = JSON.parse(saved);
      }
    }

    function exportToCSV() {
      if (alarms.length === 0) {
        alert('저장할 알람이 없습니다!');
        return;
      }

      let csvContent = "알람시간\n";
      alarms.forEach(alarm => {
        csvContent += alarm + "\n";
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      
      link.setAttribute("href", url);
      link.setAttribute("download", "알람목록.csv");
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      alert('CSV 파일로 내보내기 완료!');
    }

    function importFromCSV(event) {
      const file = event.target.files[0];
      
      if (!file) {
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n');
        
        const newAlarms = [];
        for (let i = 1; i < lines.length; i++) {
          const time = lines[i].trim();
          if (time && /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(time)) {
            if (!alarms.includes(time) && !newAlarms.includes(time)) {
              newAlarms.push(time);
            }
          }
        }
        
        if (newAlarms.length > 0) {
          alarms = alarms.concat(newAlarms);
          saveToLocalStorage();
          displayAlarms();
          alert(`${newAlarms.length}개의 알람을 불러왔습니다!`);
        } else {
          alert('불러올 수 있는 알람이 없습니다.');
        }
      };
      
      reader.readAsText(file);
      event.target.value = '';
    }

    loadFromLocalStorage();
    displayAlarms();
    
    function updateDigitalClock() {
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const seconds = now.getSeconds().toString().padStart(2, '0');
      document.getElementById('digitalClock').textContent = `${hours}:${minutes}:${seconds}`;
    }
    
    updateDigitalClock();
    setInterval(updateDigitalClock, 1000);
    
    function toggleCheckAll() {
      const checkAll = document.getElementById('checkAll');
      const checkboxes = document.querySelectorAll('.alarmCheckbox');
      checkboxes.forEach(cb => cb.checked = checkAll.checked);
    }
    
    function deleteSelected() {
      const checkboxes = document.querySelectorAll('.alarmCheckbox:checked');
      
      if (checkboxes.length === 0) {
        alert('삭제할 알람을 선택해주세요!');
        return;
      }
      
      if (!confirm(`${checkboxes.length}개의 알람을 삭제하시겠습니까?`)) {
        return;
      }
      
      const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index)).sort((a, b) => b - a);
      
      indices.forEach(index => {
        alarms.splice(index, 1);
      });
      
      saveToLocalStorage();
      displayAlarms();
      alert('선택한 알람이 삭제되었습니다.');
    }
    
    function deleteAll() {
      if (alarms.length === 0) {
        alert('삭제할 알람이 없습니다!');
        return;
      }
      
      if (!confirm(`모든 알람(${alarms.length}개)을 삭제하시겠습니까?`)) {
        return;
      }
      
      alarms = [];
      saveToLocalStorage();
      displayAlarms();
      alert('모든 알람이 삭제되었습니다.');
    }
  </script>
</body>
</html>